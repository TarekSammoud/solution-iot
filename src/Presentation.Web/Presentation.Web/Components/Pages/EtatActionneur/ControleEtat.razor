@page "/actionneur/{Id:guid}/controle"
@using Application.DTOs.Actionneur
@inject Presentation.Web.Services.EtatActionneurApiService EtatService
@inject Presentation.Web.Services.ActionneurApiService ActionneurService
@inject NavigationManager Navigation

<h3>Contrôle Actionneur</h3>

@if (ErrorMessage != null)
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (Actionneur != null && Etat != null)
{
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">@Actionneur.Nom</h5>
            <p class="text-muted">Type: @Actionneur.TypeActionneur</p>

            <EditForm Model="Etat"
                      FormName="controle-actionneur"
                      OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-check form-switch mb-3">
                    <InputCheckbox class="form-check-input"
                                   id="etatActif"
                                   @bind-Value="Etat.EstActif" />
                    <label class="form-check-label" for="etatActif">
                        @(Etat.EstActif ? "ON" : "OFF")
                    </label>
                </div>

                @if (Etat.EstActif &&
                            (Actionneur.TypeActionneur == TypeActionneur.AmpouleVariometre ||
                            Actionneur.TypeActionneur == TypeActionneur.Moteur))
                {
                    <div class="mb-3">
                        <label class="form-label">Pourcentage: <strong>@Etat.Pourcentage%</strong></label>
                        <input type="range"
                               min="0"
                               max="100"
                               @bind="Etat.Pourcentage"
                               @bind:event="oninput"
                               class="form-range" />
                    </div>
                }

                <div class="mt-4">
                    <button class="btn btn-success" type="submit">Appliquer</button>
                    <a href="/actionneur/@Id/details" class="btn btn-outline-secondary ms-2">Annuler</a>
                </div>
            </EditForm>
        </div>
    </div>
}
else if (!IsLoading)
{
    <div class="alert alert-danger">Impossible de charger l'actionneur ou son état.</div>
    <a href="/actionneurs" class="btn btn-secondary">Retour</a>
}
else
{
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Chargement...</span>
    </div>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    [SupplyParameterFromForm]
    private UpdateEtatActionneurDto? Etat { get; set; }

    private ActionneurDto? Actionneur { get; set; }
    private string? ErrorMessage { get; set; }
    private bool IsLoading { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load actionneur data
            Actionneur = await ActionneurService.GetByIdAsync(Id);

            if (Actionneur == null)
            {
                ErrorMessage = "Actionneur introuvable.";
                IsLoading = false;
                return;
            }

            // Only load state if this is NOT a form post (Etat will be null on GET)
            if (Etat == null)
            {
                var etatDto = await EtatService.GetEtatByActionneurIdAsync(Id);

                if (etatDto != null)
                {
                    Etat = new UpdateEtatActionneurDto
                    {
                        EstActif = etatDto.EstActif,
                        Pourcentage = etatDto.Pourcentage
                    };
                }
                else
                {
                    // Initialize with default values if no state exists
                    Etat = new UpdateEtatActionneurDto
                    {
                        EstActif = false,
                        Pourcentage = 0
                    };
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur lors du chargement: {ex.Message}";
            Console.WriteLine($"Erreur: {ex}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (Etat != null)
            {
                Console.WriteLine($"Updating state - EstActif: {Etat.EstActif}, Pourcentage: {Etat.Pourcentage}");

                await EtatService.UpdateEtatAsync(Id, Etat);
                Navigation.NavigateTo($"/actionneur/{Id}/details");
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur lors de la mise à jour: {ex.Message}";
            Console.WriteLine($"Erreur update: {ex}");
        }
    }
}