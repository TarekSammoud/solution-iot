@page "/seuilalerte/create/{SondeId:guid}/{TypeSeuil:int}"
@inject Presentation.Web.Services.SeuilAlerteApiService ApiService
@inject NavigationManager Navigation
@inject SondeApiService SondeApiService
@using Application.DTOs.SeuilAlerte
@using Domain.Enums
@using System.Text.Json
@rendermode InteractiveServer


<h3>Créer un seuil - @typeLabel pour la sonde @SondeNom</h3>

@if (isLoading)
{
    <p>Chargement...</p>
}
else
{
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit" FormName="CreateSeuilForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Sonde</label>
            <input class="form-control" value="@SondeNom" disabled />
        </div>

        <div class="mb-3">
            <label>Type</label>
            <input class="form-control" value="@typeLabel" disabled />
        </div>

        <div class="mb-3">
            <label>Valeur (@Unite)</label>
            <InputNumber TValue="decimal" class="form-control" @bind-Value="model.Valeur" />
            @if (!string.IsNullOrEmpty(valueWarning))
            {
                <div class="text-danger">@valueWarning</div>
            }
        </div>

        <div class="mb-3 form-check">
            <InputCheckbox class="form-check-input" @bind-Value="model.EstActif" />
            <label class="form-check-label">Actif</label>
        </div>

        @if (existingActiveWarning != null)
        {
            <div class="alert alert-warning">@existingActiveWarning</div>
        }

        <button class="btn btn-primary" type="submit">Créer</button>
        <button class="btn btn-secondary ms-2" @onclick="Cancel" type="button">Annuler</button>
    </EditForm>
}

@code {
    [Parameter] public Guid SondeId { get; set; }
    [Parameter] public TypeSeuil TypeSeuil { get; set; }


    private bool isLoading = true;
    private string SondeNom = "";
    private string errorMessage = "";
    private string Unite = "";
    private decimal? SondeValeurMin;
    private decimal? SondeValeurMax;
    private string? existingActiveWarning;
    private string? valueWarning;
    private string typeLabel => TypeSeuil == TypeSeuil.Minimum ? "Minimum" : "Maximum";

    [SupplyParameterFromForm]
    private CreateSeuilAlerteDto model { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        model.SondeId = SondeId;
        model.TypeSeuil = TypeSeuil;
        model.EstActif = true;

        await Load();
    }

    private async Task Load()
    {
        isLoading = true;
        try
        {
            var sonde = await SondeApiService.GetByIdAsync(SondeId);
            if (sonde != null)
            {
                SondeNom = sonde.Nom;
                Unite = sonde.UniteMesureId.ToString() ?? "";
                SondeValeurMin = sonde.ValeurMin;
                SondeValeurMax = sonde.ValeurMax;
            }

            var seuils = await ApiService.GetBySondeAsync(SondeId);
            var actif = seuils.FirstOrDefault(s => s.TypeSeuil == TypeSeuil && s.EstActif);
            if (actif != null)
            {
                existingActiveWarning = $"Un seuil {typeLabel} est déjà actif (valeur {actif.Valeur}). Il sera automatiquement désactivé si vous activez celui-ci.";
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            Console.WriteLine($"Valeur: {model.Valeur}, EstActif: {model.EstActif}");
            var res = await ApiService.CreateAsync(model);

            if (res.IsSuccessStatusCode)
            {
                Navigation.NavigateTo($"/sonde/{SondeId}");
            }
            else
            {
                var txt = await res.Content.ReadAsStringAsync();

                try
                {
                    var errorJson = JsonDocument.Parse(txt);
                    if (errorJson.RootElement.TryGetProperty("message", out var messageElement))
                    {
                        errorMessage = messageElement.GetString();
                    }
                    else
                    {
                        errorMessage = txt; 
                    }
                }
                catch
                {
                    errorMessage = txt; 
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }
    private void Cancel() => Navigation.NavigateTo($"/seuilalerte/sonde/{SondeId}/seuilalerte");

    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;
}
