@page "/seuilalerte/delete/{Id:guid}"
@inject Presentation.Web.Services.SeuilAlerteApiService ApiService
@inject NavigationManager Navigation
@using Application.DTOs.SeuilAlerte

<h3>Supprimer un seuil</h3>

@if (isLoading)
{
    <p>Chargement...</p>
}
else if (model == null)
{
    <p class="text-danger">Seuil introuvable.</p>
}
else
{
    <div class="card">
        <div class="card-body">
            <p><strong>Sonde :</strong> @model.SondeId</p>
            <p><strong>Type :</strong> @model.TypeSeuil</p>
            <p><strong>Valeur :</strong> @model.Valeur</p>
            <p><strong>Date création :</strong> @model.DateCreation.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
            <!-- afficher nombre d'alertes générées si besoin (nécessite endpoint) -->
            <div class="mt-3">
                <button class="btn btn-danger" @onclick="ConfirmDelete">Supprimer</button>
                <button class="btn btn-secondary ms-2" @onclick="Cancel">Annuler</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private SeuilAlerteDto? model;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync() => await Load();

    private async Task Load()
    {
        isLoading = true;
        model = await ApiService.GetByIdAsync(Id);
        isLoading = false;
    }

    private async Task ConfirmDelete()
    {
        var res = await ApiService.DeleteAsync(Id);
        if (res.IsSuccessStatusCode)
        {
            Navigation.NavigateTo($"/seuilalerte/sonde/{model!.SondeId}");
        }
        else
        {
            var txt = await res.Content.ReadAsStringAsync();
            await JSRuntime.InvokeVoidAsync("alert", $"Erreur: {txt}");
        }
    }

    private void Cancel()
    {
        if (model != null) Navigation.NavigateTo($"/seuilalerte/sonde/{model.SondeId}");
        else Navigation.NavigateTo("/");
    }

    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;
}
