@page "/actionneur/{Id:guid}/edit"
@using Application.DTOs.Actionneur
@using Application.DTOs.Localisation
@inject Presentation.Web.Services.ActionneurApiService ActionneurService
@inject Presentation.Web.Services.LocalisationApiService LocalisationService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<h3>Modifier Actionneur</h3>

@if (ErrorMessage != null)
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (EditActionneur != null && Localisations.Any())
{
    <EditForm Model="EditActionneur"
              FormName="edit-actionneur"
              OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Nom</label>
            <InputText class="form-control" @bind-Value="EditActionneur.Nom" />
            <ValidationMessage For="() => EditActionneur.Nom" />
        </div>

        <div class="mb-3">
            <label class="form-label">Type Actionneur</label>
            <InputSelect class="form-select" @bind-Value="EditActionneur.TypeActionneur">
                <option value="">-- Choisir --</option>
                @foreach (var t in Enum.GetValues<TypeActionneur>())
                {
                    <option value="@t">@t</option>
                }
            </InputSelect>
            <ValidationMessage For="() => EditActionneur.TypeActionneur" />
        </div>

        <div class="mb-3">
            <label class="form-label">Localisation</label>
            <InputSelect class="form-select" @bind-Value="EditActionneur.LocalisationId">
                <option value="">-- Choisir --</option>
                @foreach (var loc in Localisations)
                {
                    <option value="@loc.Id">@loc.Nom</option>
                }
            </InputSelect>
            <ValidationMessage For="() => EditActionneur.LocalisationId" />
        </div>

        <div class="mb-3">
            <label class="form-label">Date Installation</label>
            <InputDate class="form-control" @bind-Value="EditActionneur.DateInstallation" />
            <ValidationMessage For="() => EditActionneur.DateInstallation" />
        </div>

        <div class="mt-4">
            <button class="btn btn-warning" type="submit">Enregistrer</button>
            <a href="/actionneurs" class="btn btn-outline-secondary ms-2">Annuler</a>
        </div>
    </EditForm>
}
else
{
    <p>Chargement...</p>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    [SupplyParameterFromForm]
    private UpdateActionneurDto? EditActionneur { get; set; }

    private List<LocalisationDto> Localisations { get; set; } = new();
    private string? ErrorMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Load localisations every time
        try
        {
            var locs = await LocalisationService.GetAllAsync();
            Localisations = locs?.ToList() ?? new List<LocalisationDto>();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur chargement localisations: {ex.Message}";
            Console.WriteLine($"Erreur: {ex}");
        }

        // Only load the actionneur data if this is NOT a form post
        if (EditActionneur == null)
        {
            try
            {
                var dto = await ActionneurService.GetByIdAsync(Id);
                if (dto != null)
                {
                    EditActionneur = new UpdateActionneurDto
                    {
                        Id = dto.Id,
                        Nom = dto.Nom,
                        TypeActionneur = dto.TypeActionneur,
                        LocalisationId = dto.LocalisationId,
                        DateInstallation = dto.DateInstallation
                    };
                }
                else
                {
                    ErrorMessage = "Actionneur introuvable.";
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Erreur chargement actionneur: {ex.Message}";
                Console.WriteLine($"Erreur: {ex}");
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (EditActionneur != null)
            {
                // Make sure the Id is set correctly
                EditActionneur.Id = Id;

                var success = await ActionneurService.UpdateAsync(EditActionneur);

                // Add logging to debug
                Console.WriteLine($"Update called for Id: {Id}");
                Console.WriteLine($"Update success: {success}");

                Navigation.NavigateTo("/actionneurs");
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur lors de la mise Ã  jour: {ex.Message}";
            Console.WriteLine($"Erreur update: {ex}");
        }
    }
}