@page "/systeme-partenaires"
@using Application.DTOs
@using Application.DTOs.SystemePartenaire
@using Microsoft.AspNetCore.WebUtilities
@using Presentation.Web.Services
@inject SystemePartenaireApiService ApiService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Systèmes Partenaires</PageTitle>

<h3>Systèmes Partenaires</h3>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="NavigateToCreate">
        <span class="oi oi-plus" aria-hidden="true"></span> Nouveau système partenaire
    </button>
    <span class="ms-3 text-muted">Total: @systemes.Count</span>
    @if (isLoading)
    {
        <span class="ms-3 spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
    }
    else
    {
        <span class="ms-2 badge bg-secondary">chargé</span>
    }
</div>

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Succès !</strong> @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null" aria-label="Close"></button>
    </div>
}

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
        <p>Chargement des systèmes partenaires...</p>
    </div>
}
else if (systemes.Count == 0)
{
    <div class="alert alert-info" role="alert">
        Aucun système partenaire trouvé. Cliquez sur "Nouveau système partenaire" pour en créer un.
    </div>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Nom</th>
                <th>URL de base</th>
                <th>Mode(s) actif(s)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var systeme in systemes)
            {
                var id = systeme.Id;
                <tr>
                    <td>@systeme.Nom</td>
                    <td>@systeme.UrlBase</td>
                    <td>@GetModesText(systeme)</td>
                    <td>
                        <a href="/systeme-partenaires/details/@id" class="btn btn-sm btn-primary">
                            <span class="oi oi-eye" aria-hidden="true"></span> Details
                        </a>
                        <a href="/systeme-partenaires/edit/@id" class="btn btn-sm btn-warning">
                            <span class="oi oi-pencil" aria-hidden="true"></span> Modifier
                        </a>
                        <a href="/systeme-partenaires/delete/@id" class="btn btn-sm btn-danger ms-2">
                            <span class="oi oi-trash" aria-hidden="true"></span> Supprimer
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<SystemePartenaireDto> systemes = new();
    private bool isLoading = true;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            systemes = await ApiService.GetAllAsync();
            ParseSuccessQuery();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement des systèmes partenaires: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/systeme-partenaires/create");
    }

    private void NavigateToEdit(Guid id)
    {
        Navigation.NavigateTo($"/systeme-partenaires/edit/{id}");
    }

    private void NavigateToDetails(Guid id)
    {
        Navigation.NavigateTo($"/systeme-partenaires/details/{id}");
    }
    

    private void NavigateToDelete(Guid id)
    {
        Navigation.NavigateTo($"/systeme-partenaires/delete/{id}");
    }

    private string GetModesText(SystemePartenaireDto s)
    {
        var appelant = !string.IsNullOrWhiteSpace(s.UsernameAppel);
        var appele = !string.IsNullOrWhiteSpace(s.UsernameAcces);
        if (appelant && appele) return "Appelant + Appelé";
        if (appelant) return "Appelant";
        if (appele) return "Appelé";
        return "Aucun";
    }

    private void ParseSuccessQuery()
    {
        var uri = new Uri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("created", out var c) && c == "1")
        {
            successMessage = "Le système partenaire a été créé avec succès.";
        }
        else if (query.TryGetValue("updated", out var u) && u == "1")
        {
            successMessage = "Le système partenaire a été modifié avec succès.";
        }
        else if (query.TryGetValue("deleted", out var d) && d == "1")
        {
            successMessage = "Le système partenaire a été supprimé avec succès.";
        }
    }
}
